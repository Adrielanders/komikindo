<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Reader - Komiku Indo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        margin: 0;
        background: #050812;
        color: white;
        font-family: Arial, sans-serif;
      }

      header {
        position: sticky;
        top: 0;
        padding: 10px 16px;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(12px);
        z-index: 20;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .title {
        font-size: 14px;
        opacity: 0.7;
      }

      .reader-container {
        width: 100%;
        max-width: 760px;
        margin: auto;
        padding: 20px 0;
      }

      .chapter-title {
        font-size: 16px;
        margin: 12px 0 4px;
        opacity: 0.9;
      }

      .chapter-info {
        font-size: 12px;
        color: #95a0c3;
        margin-bottom: 10px;
      }

      .page-img {
        width: 100%;
        margin-bottom: 10px;
        background: #0f1423;
        border-radius: 6px;
      }

      .loading {
        text-align: center;
        padding: 20px;
        font-size: 12px;
        color: #8c96b8;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="title" id="headerTitle">Memuat...</div>
    </header>

    <div class="reader-container" id="readerContainer"></div>
    <div class="loading" id="loading">Memuat chapter...</div>

    <script>
      const params = new URLSearchParams(window.location.search);

      const series = params.get("series") || "solo-leveling";
      let currentChapter = parseInt(params.get("chapter") || "1", 10);
      if (Number.isNaN(currentChapter) || currentChapter < 1)
        currentChapter = 1;

      // dari reader/ ke folder manhwa/
      const BASE_PATH = "../manhwa/";

      const readerContainer = document.getElementById("readerContainer");
      const loadingEl = document.getElementById("loading");
      const headerTitle = document.getElementById("headerTitle");

      let isLoading = false;
      let finishedAll = false;

      // Load satu halaman gambar
      function loadPage(src, alt) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => resolve({ ok: true, img });
          img.onerror = () => resolve({ ok: false });
          img.src = src;
          img.alt = alt;
          img.className = "page-img";
          img.loading = "lazy";
        });
      }

      // Main loader untuk 1 chapter â†’ otomatis naik ke chapter berikutnya
      async function loadChapter(chapterNumber) {
        const block = document.createElement("section");
        block.className = "chapter-block";

        const title = document.createElement("div");
        title.className = "chapter-title";
        title.textContent = `Chapter ${chapterNumber}`;
        const info = document.createElement("div");
        info.className = "chapter-info";
        info.textContent = series.replace(/-/g, " ");
        block.append(title, info);

        // =============================
        // 1. Generate kandidat file 01.jpg â†’ 200.jpg
        // =============================
        const MAX = 300; // batas aman
        let urls = [];
        for (let i = 1; i <= MAX; i++) {
          let pageStr = i < 10 ? "0" + i : i.toString();
          urls.push({
            src: `${BASE_PATH}${series}/${chapterNumber}/${pageStr}.jpg`,
            alt: `${series} ch${chapterNumber} p${i}`,
          });
        }

        // =============================
        // 2. Load semua gambar paralel (lebih cepat)
        // =============================
        const results = await Promise.all(
          urls.map((u) => loadPage(u.src, u.alt))
        );

        let foundAny = false;

        for (let r of results) {
          if (!r.ok) {
            if (!foundAny) return false; // folder tidak ada
            break; // halaman selesai
          }

          foundAny = true;

          const wrap = document.createElement("div");
          wrap.className = "page-wrap";
          wrap.appendChild(r.img);
          block.appendChild(wrap);
        }

        if (!foundAny) return false;

        // footer
        const footer = document.createElement("div");
        footer.className = "chapter-footer";
        footer.textContent = `Selesai chapter ${chapterNumber}. Scroll untuk lanjut...`;
        block.appendChild(footer);

        readerContainer.appendChild(block);

        // update judul header
        if (readerContainer.children.length === 1) {
          headerTitle.textContent =
            series.replace(/-/g, " ") + " â€¢ Chapter " + chapterNumber;
        }

        return true;
      }

      // Auto load chapter pertama
      async function loadNextChapter() {
        if (finishedAll || isLoading) return;

        isLoading = true;
        loadingEl.textContent = `Memuat chapter ${currentChapter}...`;

        const ok = await loadChapter(currentChapter);

        if (!ok) {
          if (readerContainer.children.length === 0) {
            loadingEl.textContent = `âŒ Chapter ${currentChapter} tidak ditemukan.`;
          } else {
            loadingEl.textContent = "ðŸ“š Tidak ada chapter lagi.";
          }
          finishedAll = true;
          return;
        }

        currentChapter++;
        loadingEl.textContent = "Scroll untuk lanjut...";
        isLoading = false;
      }

      // Start
      loadNextChapter();

      // Infinite scroll
      window.addEventListener("scroll", () => {
        if (finishedAll || isLoading) return;

        const nearBottom =
          window.innerHeight + window.scrollY >=
          document.body.offsetHeight - 300;

        if (nearBottom) loadNextChapter();
      });
    </script>
  </body>
</html>
