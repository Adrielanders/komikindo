<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Reader - Komiku Indo</title>
    <link rel="icon" type="image/x-icon" href="../faico.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        margin: 0;
        background: #050812;
        color: white;
        font-family: Arial, sans-serif;
      }

      header {
        position: sticky;
        top: 0;
        padding: 8px 16px;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(12px);
        z-index: 20;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);

        display: flex; /* baris */
        align-items: center; /* vertikal tengah */
        justify-content: space-between; /* kiri-kanan */
        gap: 8px;
      }
      
      .title {
        font-size: 14px;
        opacity: 0.7;
        flex: 1; /* biar judul bisa memanjang */
        text-align: right; /* judul di kanan, tombol di kiri */
      }

      .reader-container {
        width: 100%;
        max-width: 760px;
        margin: auto;
        padding: 20px 0 10px;
      }

      .chapter-title {
        font-size: 16px;
        margin: 12px 0 4px;
        opacity: 0.9;
      }

      .chapter-info {
        font-size: 12px;
        color: #95a0c3;
        margin-bottom: 10px;
      }

      .page-img {
        width: 100%;
        margin-bottom: -6px;
        background: #0f1423;
        display: block;
      }

      .loading {
        text-align: center;
        padding: 10px 16px 18px;
        font-size: 12px;
        color: #8c96b8;
      }

      .chapter-block {
        margin-bottom: 12px;
      }

      .page-wrap {
        margin-bottom: 6px;
      }

      .chapter-footer {
        font-size: 11px;
        color: #9ca3af;
        text-align: center;
        margin-top: 8px;
      }

      /* NAVIGATION CHAPTER */
      .nav-chapter {
        max-width: 760px;
        margin: 0 auto 12px;
        padding: 0 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        flex-wrap: wrap;
      }

      .nav-btn {
        flex: 1;
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid #374151;
        background: #111827;
        color: #e5e7eb;
        font-size: 13px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: background 0.15s ease, transform 0.1s ease;
      }

      .nav-btn:hover:not(:disabled) {
        background: #1f2937;
        transform: translateY(-1px);
      }

      .nav-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .nav-center {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        min-width: 0;
      }

      .nav-center-top {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
      }

      .nav-center-top input {
        width: 60px;
        padding: 4px 6px;
        border-radius: 4px;
        border: 1px solid #374151;
        background: #020617;
        color: #e5e7eb;
        font-size: 12px;
        text-align: center;
      }

      .nav-center-top button {
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #4b5563;
        background: #111827;
        color: #e5e7eb;
        font-size: 12px;
        cursor: pointer;
      }

      .nav-center-top button:hover {
        background: #1f2937;
      }

      .nav-center-info {
        font-size: 11px;
        color: #9ca3af;
      }

      @media (max-width: 640px) {
        .nav-chapter {
          flex-direction: column;
          align-items: stretch;
        }
        .nav-btn {
          width: 100%;
        }
        .nav-center {
          align-items: flex-start;
        }
      }
      .back-btn {
        background: #111827;
        color: #e5e7eb;
        font-size: 12px;
        padding: 6px 10px;
        border: 1px solid #374151;
        border-radius: 6px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .back-btn:hover {
        background: #1f2937;
      }
    </style>
  </head>
  <body>
    <header>
      <button id="backBtn" class="back-btn">⬅ Kembali ke Daftar Chapter</button>
      <div class="title" id="headerTitle">Memuat...</div>
    </header>

    <div class="reader-container" id="readerContainer"></div>
    <div class="loading" id="loading">Memuat chapter...</div>

    <!-- Navigation + choose chapter -->
    <div class="nav-chapter">
      <button class="nav-btn" id="prevBtn">⬅ Chapter Sebelumnya</button>

      <div class="nav-center">
        <div class="nav-center-top">
          <span>Ke chapter:</span>
          <input
            type="number"
            id="chapterInput"
            min="1"
            step="1"
            inputmode="numeric" />
          <button id="goBtn">Pergi</button>
        </div>
        <div class="nav-center-info" id="chapterInfo">Sedang di Chapter -</div>
      </div>

      <button class="nav-btn" id="nextBtn">Chapter Selanjutnya ➡</button>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);

      const series = params.get("series") || "solo-leveling";
      let currentChapter = parseInt(params.get("chapter") || "1", 10);
      if (Number.isNaN(currentChapter) || currentChapter < 1)
        currentChapter = 1;

      const BASE_PATH = "../manhwa/";

      const readerContainer = document.getElementById("readerContainer");
      const loadingEl = document.getElementById("loading");
      const headerTitle = document.getElementById("headerTitle");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const chapterInput = document.getElementById("chapterInput");
      const chapterInfo = document.getElementById("chapterInfo");
      const goBtn = document.getElementById("goBtn");

      // helper: pindah ke chapter tertentu
      function navigateToChapter(ch) {
        if (!ch || ch < 1) return;
        const url =
          "?series=" +
          encodeURIComponent(series) +
          "&chapter=" +
          encodeURIComponent(ch);
        window.location.search = url;
      }

      // helper load satu gambar
      function loadPage(src, alt) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => resolve({ ok: true, img });
          img.onerror = () => resolve({ ok: false });
          img.src = src;
          img.alt = alt;
          img.className = "page-img";
          img.loading = "lazy";
        });
      }

      // render 1 chapter (PARALEL)
      async function loadChapter(chapterNumber) {
        readerContainer.innerHTML = "";

        const block = document.createElement("section");
        block.className = "chapter-block";

        const title = document.createElement("div");
        title.className = "chapter-title";
        title.textContent = `Chapter ${chapterNumber}`;
        const info = document.createElement("div");
        info.className = "chapter-info";
        info.textContent = series.replace(/-/g, " ");
        block.append(title, info);

        const MAX = 200;
        const candidates = [];
        for (let i = 1; i <= MAX; i++) {
          const pageStr = i < 10 ? "0" + i : i.toString();
          candidates.push({
            src: `${BASE_PATH}${series}/${chapterNumber}/${pageStr}.jpg`,
            alt: `${series} ch${chapterNumber} p${i}`,
          });
        }

        const results = await Promise.all(
          candidates.map((c) => loadPage(c.src, c.alt))
        );

        let foundAny = false;

        for (const r of results) {
          if (!r.ok) {
            if (!foundAny) return false;
            break;
          }

          foundAny = true;
          const wrap = document.createElement("div");
          wrap.className = "page-wrap";
          wrap.appendChild(r.img);
          block.appendChild(wrap);
        }

        if (!foundAny) return false;

        const footer = document.createElement("div");
        footer.className = "chapter-footer";
        footer.textContent =
          "Selesai Chapter " +
          chapterNumber +
          ". Gunakan tombol di bawah untuk pindah chapter.";
        block.appendChild(footer);

        readerContainer.appendChild(block);

        const niceSeries = series
          .replace(/-/g, " ")
          .replace(/\s+/g, " ")
          .toLowerCase()
          .replace(/\b\w/g, (c) => c.toUpperCase());

        headerTitle.textContent = niceSeries + " • Chapter " + chapterNumber;

        if (chapterInfo) {
          chapterInfo.textContent = "Sedang di Chapter " + chapterNumber;
        }
        if (chapterInput) {
          chapterInput.value = chapterNumber;
        }

        return true;
      }

      // init
      (async function init() {
        loadingEl.textContent = `Memuat chapter ${currentChapter}...`;
        const ok = await loadChapter(currentChapter);

        if (!ok) {
          loadingEl.textContent =
            "❌ Chapter " +
            currentChapter +
            " tidak ditemukan. Pastikan folder dan nama file benar.";
        } else {
          loadingEl.textContent = "";
        }

        if (currentChapter <= 1) {
          prevBtn.disabled = true;
        }
      })();

      // tombol prev/next
      prevBtn.addEventListener("click", () => {
        if (currentChapter <= 1) return;
        navigateToChapter(currentChapter - 1);
      });

      nextBtn.addEventListener("click", () => {
        navigateToChapter(currentChapter + 1);
      });

      // pilih chapter manual (input + tombol)
      goBtn.addEventListener("click", () => {
        const target = parseInt(chapterInput.value, 10);
        if (Number.isNaN(target) || target < 1) return;
        navigateToChapter(target);
      });

      chapterInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const target = parseInt(chapterInput.value, 10);
          if (Number.isNaN(target) || target < 1) return;
          navigateToChapter(target);
        }
      });

      const backBtn = document.getElementById("backBtn");

      backBtn.addEventListener("click", () => {
        const url = "../chapters/?series=" + encodeURIComponent(series);
        window.location.href = url;
      });
    </script>
  </body>
</html>
