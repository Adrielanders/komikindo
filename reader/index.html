<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Reader - Komiku Indo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        margin: 0;
        background: #050812;
        color: white;
        font-family: Arial, sans-serif;
      }

      header {
        position: sticky;
        top: 0;
        padding: 10px 16px;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(12px);
        z-index: 20;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .title {
        font-size: 14px;
        opacity: 0.7;
      }

      .reader-container {
        width: 100%;
        max-width: 760px;
        margin: auto;
        padding: 20px 0 10px;
      }

      .chapter-title {
        font-size: 16px;
        margin: 12px 0 4px;
        opacity: 0.9;
      }

      .chapter-info {
        font-size: 12px;
        color: #95a0c3;
        margin-bottom: 10px;
      }

      .page-img {
        width: 100%;
        margin-bottom: -6px;
        background: #0f1423;
        display: block;
      }

      .loading {
        text-align: center;
        padding: 10px 16px 18px;
        font-size: 12px;
        color: #8c96b8;
      }

      .chapter-block {
        margin-bottom: 12px;
      }

      .page-wrap {
        margin-bottom: 6px;
      }

      .chapter-footer {
        font-size: 11px;
        color: #9ca3af;
        text-align: center;
        margin-top: 8px;
      }

      .nav-chapter {
        max-width: 760px;
        margin: 0 auto 24px;
        padding: 0 16px;
        display: flex;
        justify-content: space-between;
        gap: 10px;
      }

      .nav-btn {
        flex: 1;
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid #374151;
        background: #111827;
        color: #e5e7eb;
        font-size: 13px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: background 0.15s ease, transform 0.1s ease;
      }

      .nav-btn:hover:not(:disabled) {
        background: #1f2937;
        transform: translateY(-1px);
      }

      .nav-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="title" id="headerTitle">Memuat...</div>
    </header>

    <div class="reader-container" id="readerContainer"></div>
    <div class="loading" id="loading">Memuat chapter...</div>

    <!-- Navigation buttons -->
    <div class="nav-chapter">
      <button class="nav-btn" id="prevBtn">⬅ Chapter Sebelumnya</button>
      <button class="nav-btn" id="nextBtn">Chapter Selanjutnya ➜</button>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);

      const series = params.get("series") || "solo-leveling";
      let currentChapter = parseInt(params.get("chapter") || "1", 10);
      if (Number.isNaN(currentChapter) || currentChapter < 1)
        currentChapter = 1;

      const BASE_PATH = "../manhwa/";

      const readerContainer = document.getElementById("readerContainer");
      const loadingEl = document.getElementById("loading");
      const headerTitle = document.getElementById("headerTitle");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");

      // helper load satu gambar
      function loadPage(src, alt) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => resolve({ ok: true, img });
          img.onerror = () => resolve({ ok: false });
          img.src = src;
          img.alt = alt;
          img.className = "page-img";
          img.loading = "lazy";
        });
      }


      // render 1 chapter (PARALEL, SUPER CEPAT)
      async function loadChapter(chapterNumber) {
        readerContainer.innerHTML = ""; // bersihkan isi sebelumnya

        const block = document.createElement("section");
        block.className = "chapter-block";

        const title = document.createElement("div");
        title.className = "chapter-title";
        title.textContent = `Chapter ${chapterNumber}`;
        const info = document.createElement("div");
        info.className = "chapter-info";
        info.textContent = series.replace(/-/g, " ");
        block.append(title, info);

        // Generate URL gambar 01–300
        const MAX = 150;
        const candidates = [];
        for (let i = 1; i <= MAX; i++) {
          const pageStr = i < 10 ? "0" + i : i.toString();
          candidates.push({
            src: `${BASE_PATH}${series}/${chapterNumber}/${pageStr}.jpg`,
            alt: `${series} ch${chapterNumber} p${i}`,
          });
        }

        // Load semua gambar paralel
        const results = await Promise.all(
          candidates.map((c) => loadPage(c.src, c.alt))
        );

        let foundAny = false;

        for (const r of results) {
          if (!r.ok) {
            if (!foundAny) return false; // folder tidak ada sama sekali
            break; // selesai chapter
          }

          foundAny = true;
          const wrap = document.createElement("div");
          wrap.className = "page-wrap";
          wrap.appendChild(r.img);
          block.appendChild(wrap);
        }

        if (!foundAny) return false;

        const footer = document.createElement("div");
        footer.className = "chapter-footer";
        footer.textContent =
          "Selesai Chapter " +
          chapterNumber +
          ". Gunakan tombol di bawah untuk pindah chapter.";
        block.appendChild(footer);

        readerContainer.appendChild(block);

        headerTitle.textContent =
          series.replace(/-/g, " ") + " • Chapter " + chapterNumber;

        return true;
      }

      // init: load chapter dari URL
      (async function init() {
        loadingEl.textContent = `Memuat chapter ${currentChapter}...`;
        const ok = await loadChapter(currentChapter);

        if (!ok) {
          loadingEl.textContent =
            "❌ Chapter " +
            currentChapter +
            " tidak ditemukan. Pastikan folder dan nama file benar.";
        } else {
          loadingEl.textContent = "";
        }

        // disable tombol prev kalau di chapter 1
        if (currentChapter <= 1) {
          prevBtn.disabled = true;
        }
      })();

      // tombol prev/next: redirect dengan chapter baru
      prevBtn.addEventListener("click", () => {
        if (currentChapter <= 1) return;
        const prev = currentChapter - 1;
        const url =
          "?series=" +
          encodeURIComponent(series) +
          "&chapter=" +
          encodeURIComponent(prev);
        window.location.search = url;
      });

      nextBtn.addEventListener("click", () => {
        const next = currentChapter + 1;
        const url =
          "?series=" +
          encodeURIComponent(series) +
          "&chapter=" +
          encodeURIComponent(next);
        window.location.search = url;
      });
    </script>
  </body>
</html>
